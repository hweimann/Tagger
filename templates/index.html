<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Generador de TAG ‚Äî M√∫ltiples filas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --font-size: 12px;
      --cell-pad: 4px 6px;
      --colw: 88px;
      --tagw: 260px;
      --descw: 420px;   /* ancho Descripci√≥n */
      --actionsw: 90px;
      --repw: 54px;
      --refw: 320px;    /* REF m√°s ancha */
    }
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; font-size: var(--font-size); }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    button, select, input, textarea { padding:6px; font-size: var(--font-size); }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    thead th { position: sticky; top:0; background:#fff; z-index:1; }
    th, td { border-bottom:1px solid #eee; padding: var(--cell-pad); text-align:left; vertical-align: middle; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    th.col, td.col       { width: var(--colw); }
    th.tagcol, td.tagcol { width: var(--tagw); }
    th.desccol, td.desccol { width: var(--descw); }
    th.actcol, td.actcol { width: var(--actionsw); }
    th.repcol, td.repcol { width: var(--repw); text-align:center; }
    th.refcol, td.refcol { width: var(--refw); }
    td select, td input, td textarea { width: 100%; min-width: 0; }
    .muted { color:#666; }
    .nowrap { white-space: nowrap; }
    td.refcol { white-space: normal; }
    td.refcol textarea.refinput {
      width: 100%;
      min-height: 2.2em;
      max-height: 8.5em;
      resize: vertical;
      overflow: auto;
      line-height: 1.2;
      font: inherit;
      box-sizing: border-box;
      white-space: pre-wrap;
    }
    @media (max-width: 1440px){
      :root{ --font-size: 12px; --colw: 80px; --tagw: 220px; --descw: 360px; --actionsw: 80px; --repw: 48px; }
    }
  </style>
</head>
<body>
  <h1 style="margin:0 0 8px;">Generador de TAG</h1>
  <p class="muted" style="margin:0 0 12px;">
    Formato: <code>[TIPO][LUGAR].[SIGLAS].[NIVEL][DISPOSITIVO][PROTECCION_SECUNDARIA][QUE][SE√ëAL][NUMERO]</code>
  </p>

  <div class="toolbar">
        <button id="templatesOpen">TEMPLATES</button>

    <button id="add">+ Agregar fila</button>
    <button id="dup">Duplicar √∫ltima</button>
    <button id="clear">Vaciar todo</button>
    <button id="exportCsv">‚¨áÔ∏è Exportar CSV</button>
    <button id="pasteMulti">üìã Pegar (multi)</button>

    <a href="/tables">üîß Ver / Editar listas</a>
    <a href="/export/listas.zip" class="nowrap">‚¨áÔ∏è Exportar Listas+Reglas</a>

    <label style="display:flex; align-items:center; gap:6px; margin-left:8px;">
      <input type="checkbox" id="toggleCompact" checked>
      Modo compacto
    </label>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th class="col refcol">REF</th>
        <th class="col">TIPO</th>
        <th class="col">LUGAR</th>
        <th class="col">OBJETO</th>
        <th class="col">SIGLAS</th>
        <th class="col">NIVEL</th>
        <th class="col">DISPOSITIVO</th>
        <th class="col">PROT. SEC.</th>
        <th class="col">QUE</th>
        <th class="col">SE√ëAL</th>
        <th class="col">NUMERO</th>
        <th class="tagcol">TAG</th>
        <th class="desccol">DESCRIPCION</th>
        <th class="repcol">REP</th>
        <th class="actcol"></th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <h2 style="margin-top:18px;">Notas/Reglas</h2>
  <ul>
    {% for r in reglas %}<li>{{ r }}</li>{% endfor %}
  </ul>

  <!-- Modal para pegado masivo -->
  <div id="pasteModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.25); align-items:center; justify-content:center; z-index:9999;">
    <div style="background:#fff; padding:16px; border-radius:10px; width: min(900px, 92vw); box-shadow:0 8px 40px rgba(0,0,0,.2);">
      <h3 style="margin-top:0">Pegar filas (Excel / CSV / TXT)</h3>
      <p class="muted" style="margin:6px 0 8px">
        Orden esperado: <code>REF, TIPO, LUGAR, OBJETO, SIGLAS, NIVEL, DISPOSITIVO, PROTECCION SECUNDARIA, QUE, SE√ëAL, NUMERO</code>
      </p>
      <textarea id="pasteArea" rows="12" style="width:100%; font-family:monospace; font-size:12px;"></textarea>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button id="pasteCancel">Cancelar</button>
        <button id="pasteApply">Agregar filas</button>
      </div>
    </div>
  </div>

  <script>const FAMILIAS = {{ familias|tojson }};</script>
  <!-- Templates dialog -->
  <dialog id="tplDialog" style="max-width: 880px; width: 90%;">
    <form method="dialog" style="margin:0; padding:0;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
        <h3 style="margin:0;">Templates de Equipos</h3>
        <div style="display:flex; gap:8px;">
          <button id="tplNew" type="button">Nuevo equipo</button>
          <button id="tplExport" type="button" title="Exportar JSON">Exportar</button>
          <label style="display:inline-flex; gap:6px; align-items:center;">
            <input id="tplImportFile" type="file" accept="application/json" style="display:none">
            <span class="button-like" style="border:1px solid #ccc; padding:6px 10px; border-radius:6px; cursor:pointer;"
                  onclick="document.getElementById('tplImportFile').click()">Importar</span>
          </label>
          <button id="tplClose" value="cancel">Cerrar</button>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;">
        <div class="card" style="max-height: 420px; overflow:auto;">
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <input id="tplSearch" placeholder="Buscar por nombre, descripci√≥n o tag‚Ä¶" style="flex:1; padding:8px;">
          </div>
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr><th style="text-align:left;">Equipo</th><th style="text-align:left;">Descripci√≥n</th><th></th></tr>
            </thead>
            <tbody id="tplList"></tbody>
          </table>
        </div>

        <div class="card" style="max-height: 420px; overflow:auto;">
          <h4 style="margin-top:0;">Vista previa (Se√±al)</h4>
          <table style="width:100%; border-collapse:collapse;">
            <thead><tr><th style="text-align:left;width:50px;">#</th><th style="text-align:left;">Se√±al</th></tr></thead>
            <tbody id="tplPreview"></tbody>
          </table>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; margin-top:12px;">
        <div>
          <button id="tplEdit" type="button">Editar equipo</button>
          <button id="tplDelete" type="button" style="margin-left:8px;">Eliminar equipo</button>
        </div>
        <button id="tplApply" type="button" style="background:#0a7; color:white; padding:8px 12px; border-radius:6px;">Aplicar al generador</button>
      </div>

      <!-- Editor simple -->
      <div id="tplEditor" class="card" style="margin-top:12px; display:none;">
        <h4 style="margin:0 0 8px;">Editar / Crear equipo</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <div>
            <label>Nombre</label>
            <input id="tplFormNombre" placeholder="Ej.: CELDA MT - Alimentador" style="width:100%; padding:8px;">
          </div>
          <div>
            <label>Tags (separados por coma)</label>
            <input id="tplFormTags" placeholder="MT, Protecci√≥n, Alimentador" style="width:100%; padding:8px;">
          </div>
        </div>
        <div style="margin-top:8px;">
          <label>Descripci√≥n</label>
          <textarea id="tplFormDesc" rows="2" style="width:100%; padding:8px;"></textarea>
        </div>
        <div style="margin-top:8px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <label>Filas del template (solo columna Se√±al)</label>
            <button id="tplAddItem" type="button">Agregar fila</button>
          </div>
          <table style="width:100%; border-collapse:collapse; margin-top:6px;">
            <thead><tr><th style="width:50px;">#</th><th>Se√±al</th><th style="width:80px;"></th></tr></thead>
            <tbody id="tplItems"></tbody>
          </table>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
          <button id="tplCancelEdit" type="button">Cancelar</button>
          <button id="tplSave" type="button" style="background:#06c; color:white; padding:8px 12px; border-radius:6px;">Guardar</button>
        </div>
      </div>
    </form>
  </dialog>
  <script src="/static/main.js"></script>
</body>
</html>
